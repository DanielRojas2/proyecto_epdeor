{% extends "base.html" %}
{% load static %}

{% block title %}Atender Solicitud {{ solicitud.codigo_solicitud }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

    <!-- Header de la solicitud -->
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="fas fa-tasks me-2"></i>Atender Solicitud
                </h4>
                <span class="badge bg-warning text-dark fs-6">Pendiente</span>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <strong><i class="fas fa-hashtag me-2"></i>Código:</strong>
                    <span class="ms-2">{{ solicitud.codigo_solicitud }}</span>
                </div>
                <div class="col-md-3">
                    <strong><i class="fas fa-user me-2"></i>Solicitante:</strong>
                    <span class="ms-2">{{ solicitud.creado_por.personal.nombre_completo }}</span>
                </div>
                <div class="col-md-3">
                    <strong><i class="fas fa-calendar me-2"></i>Fecha:</strong>
                    <span class="ms-2">{{ solicitud.fecha_creacion|date:"d/m/Y H:i" }}</span>
                </div>
                <div class="col-md-3">
                    <strong><i class="fas fa-flag me-2"></i>Prioridad:</strong>
                    <span class="ms-2 badge bg-{% if solicitud.prioridad == 'alta' %}danger{% elif solicitud.prioridad == 'media' %}warning{% else %}info{% endif %}">
                        {{ solicitud.prioridad|default:"Normal"|capfirst }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Detalles de materiales -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="fas fa-boxes me-2"></i>Materiales Solicitados
            </h5>
        </div>
        <div class="card-body">
            <form id="form-detalles">
                {% csrf_token %}
                
                {% for d in detalles %}
                <div class="card mb-3 border {% if forloop.first %}border-start-3 border-start-primary{% endif %}">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <h6 class="text-primary mb-2">
                                    <i class="fas fa-box me-2"></i>{{ d.material.descripcion }}
                                </h6>
                                <small class="text-muted">Código: {{ d.material.codigo_material }}</small>
                            </div>
                            
                            <div class="col-md-2">
                                <label class="form-label small fw-semibold">Cantidad Solicitada</label>
                                <input type="number"
                                       id="cant-{{ d.id }}"
                                       class="form-control form-control-sm"
                                       value="{{ d.cantidad_solicitada }}"
                                       min="1"
                                       max="{{ d.material.cantidad_existente }}"
                                       onchange="validarCantidad({{ d.id }})">
                                <div class="form-text small">Mín: 1, Máx: {{ d.material.cantidad_existente }}</div>
                            </div>

                            <div class="col-md-2">
                                <label class="form-label small fw-semibold">Stock Disponible</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-light">
                                        <i class="fas fa-warehouse"></i>
                                    </span>
                                    <input type="text" 
                                           class="form-control form-control-sm text-center fw-bold {% if d.cantidad_solicitada <= d.material.cantidad_existente %}text-success{% else %}text-danger{% endif %}"
                                           value="{{ d.material.cantidad_existente }}"
                                           disabled>
                                </div>
                            </div>

                            <div class="col-md-2">
                                <label class="form-label small fw-semibold">Estado</label>
                                <div class="text-center">
                                    {% if d.cantidad_solicitada <= d.material.cantidad_existente %}
                                        <span class="badge bg-success">Disponible</span>
                                    {% else %}
                                        <span class="badge bg-danger">Insuficiente</span>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-2">
                                <button type="button"
                                        class="btn btn-warning btn-sm w-100 mt-3"
                                        onclick="actualizarCantidad({{ d.id }})"
                                        id="btn-{{ d.id }}">
                                    <i class="fas fa-save me-1"></i>Guardar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </form>
        </div>
    </div>

    <!-- Acciones -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="d-flex gap-3">
                        <button class="btn btn-success btn-lg flex-fill" 
                                onclick="aprobarSolicitud({{ solicitud.id }})"
                                id="btn-aprobar">
                            <i class="fas fa-check-circle me-2"></i>Aprobar Solicitud
                        </button>
                        <button class="btn btn-danger btn-lg flex-fill" 
                                onclick="rechazarSolicitud({{ solicitud.id }})"
                                id="btn-rechazar">
                            <i class="fas fa-times-circle me-2"></i>Rechazar Solicitud
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/solicitudes/atender_solicitud.js' %}"></script>

<script>
// Validación en tiempo real
function validarCantidad(detalleId) {
    const input = document.getElementById(`cant-${detalleId}`);
    const max = parseInt(input.max);
    const value = parseInt(input.value) || 0;
    const btn = document.getElementById(`btn-${detalleId}`);
    
    if (value < 1 || value > max) {
        input.classList.add('is-invalid');
        btn.disabled = true;
    } else {
        input.classList.remove('is-invalid');
        btn.disabled = false;
    }
}

// Inicializar validación al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    {% for d in detalles %}
    validarCantidad({{ d.id }});
    {% endfor %}
});
</script>
{% endblock %}